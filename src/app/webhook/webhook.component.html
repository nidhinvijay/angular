<section class="webhook-page">
  <mat-toolbar color="primary" class="webhook-toolbar">
    <span>BTC Trading Engine</span>
    <span class="spacer"></span>
    <span class="webhook-url" (click)="copyWebhookUrl()" title="Click to copy">
      ðŸ“‹ https://chronic-personally-notified-triangle.trycloudflare.com/webhook
    </span>
    <span class="toolbar-subhead">Resets daily at 5:30 AM IST</span>
  </mat-toolbar>

  @if (engineState$ | async; as state) {
    <!-- LTP Display -->
    <div class="ltp-bar">
      <strong>LTP:</strong>
      @for (item of state.ltp | keyvalue; track item.key) {
        <span class="ltp-item">{{ item.key }}: {{ item.value | number:'1.2-2' }}</span>
      }
    </div>

    <div class="two-column-grid">
      <!-- LONG SECTION -->
      <mat-card class="card long-card">
        <mat-card-header class="card-header">
          <mat-card-title>
            ðŸ“ˆ LONG Position
            @if (state.long.liveState.isLiveActive) {
              <mat-chip color="primary" selected>LIVE ACTIVE</mat-chip>
            } @else if (state.long.liveState.blockedAtMs) {
              <mat-chip color="warn">ðŸ”’ BLOCKED</mat-chip>
            } @else {
              <mat-chip>IDLE</mat-chip>
            }
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- FSM State -->
          <div class="fsm-info">
            <span class="fsm-label">FSM:</span>
            <span class="fsm-state">{{ state.long.fsmState }}</span>
            <span class="fsm-label">Threshold:</span>
            <span class="fsm-value">{{ state.long.threshold ?? '--' }}</span>
          </div>

          <!-- Current Paper Trade -->
          <h4>Current Paper Trade</h4>
          @if (state.long.paperTrade) {
            <div class="trade-info">
              <div class="info-row">
                <span class="label">Entered At:</span>
                <span class="value entry-time">{{ state.long.paperTrade.timeIst }}</span>
              </div>
              <div class="info-row">
                <span class="label">Entry:</span>
                <span class="value">{{ state.long.paperTrade.entryPrice | number:'1.2-2' }}</span>
              </div>
              <div class="info-row">
                <span class="label">Current:</span>
                <span class="value">{{ state.long.paperTrade.currentPrice | number:'1.2-2' }}</span>
              </div>
              <div class="info-row pnl-row">
                <span class="label">Unrealized PnL:</span>
                <span class="value" [class.profit]="state.long.paperTrade.unrealizedPnl > 0" [class.loss]="state.long.paperTrade.unrealizedPnl < 0">
                  ${{ state.long.paperTrade.unrealizedPnl | number:'1.2-2' }}
                </span>
              </div>
            </div>
          } @else {
            <p class="empty">No LONG position open</p>
          }

          <!-- Peak PnL History -->
          <h4>Peak PnL (Highest Unrealized)</h4>
          @if (state.long.currentPeakPnl !== null) {
            <div class="peak-current">
              <span class="time">{{ state.long.currentPeakPnl.timeIst }}</span>
              <span class="peak-value profit">${{ state.long.currentPeakPnl.pnl | number:'1.2-2' }}</span>
            </div>
          }
          @if ((state.long.peakPnlHistory ?? []).length > 0) {
            <div class="trades-list scrollable">
              @for (peak of state.long.peakPnlHistory ?? []; track peak.timestamp) {
                <div class="trade-row peak-row">
                  <span class="time">{{ peak.timeIst }}</span>
                  <span class="pnl profit">${{ peak.pnl | number:'1.2-2' }}</span>
                </div>
              }
            </div>
          } @else {
            <p class="empty">No peaks recorded</p>
          }

          <!-- Paper Trades History -->
          <h4>Paper Trades History <span class="trade-count">({{ state.long.paperTradeCount }} trades)</span></h4>
          @if ((state.long.paperTrades ?? []).length > 0) {
            <div class="trades-list scrollable">
              @for (trade of state.long.paperTrades ?? []; track trade.closedAt) {
                <div class="trade-row">
                  <span class="time">{{ trade.timeIst }} â†’ {{ trade.exitTimeIst }}</span>
                  <span class="price">{{ trade.entryPrice | number:'1.2-2' }} â†’ {{ trade.exitPrice | number:'1.2-2' }}</span>
                  <span class="pnl" [class.profit]="trade.realizedPnl > 0" [class.loss]="trade.realizedPnl < 0">
                    ${{ trade.realizedPnl | number:'1.2-2' }}
                  </span>
                </div>
              }
            </div>
          } @else {
            <p class="empty">No paper trades</p>
          }

          <!-- Live Trades -->
          <h4>Live Trades <span class="trade-count">({{ state.long.liveTradeCount }} trades)</span></h4>
          @if (state.long.liveState.trades.length > 0) {
            <div class="trades-list scrollable">
              @for (trade of state.long.liveState.trades; track trade.id) {
                <div class="trade-row" [class.entry]="trade.action === 'ENTRY'" [class.exit]="trade.action === 'EXIT'">
                  <span class="time">{{ trade.timeIst }}</span>
                  <span class="action">{{ trade.action }}</span>
                  <span class="price">@ {{ trade.entryPrice | number:'1.2-2' }}</span>
                  @if (trade.realizedPnl !== null) {
                    <span class="pnl" [class.profit]="trade.realizedPnl > 0" [class.loss]="trade.realizedPnl < 0">
                      ${{ trade.realizedPnl | number:'1.2-2' }}
                    </span>
                  }
                </div>
              }
            </div>
          } @else {
            <p class="empty">No live trades (activates when PnL > $0)</p>
          }

          <!-- Signal History -->
          <h4>Signal History</h4>
          @if ((state.long.signals ?? []).length > 0) {
            <div class="trades-list scrollable">
              @for (signal of state.long.signals ?? []; track signal.receivedAt) {
                <div class="trade-row signal-row">
                  <span class="time">{{ signal.timeIst }}</span>
                  <span class="action">{{ signal.intent }}</span>
                  <span class="price">stoppx: {{ signal.stoppx ?? '--' }}</span>
                  <span class="ltp">ltp: {{ signal.ltp ?? '--' }}</span>
                </div>
              }
            </div>
          } @else {
            <p class="empty">No signals</p>
          }

          <!-- Cumulative PnL -->
          <div class="cumulative-pnl paper">
            <span class="label">Cumulative Paper PnL:</span>
            <span class="value" [class.profit]="state.long.cumPaperPnl > 0" [class.loss]="state.long.cumPaperPnl < 0">
              ${{ state.long.cumPaperPnl | number:'1.2-2' }}
            </span>
          </div>
          <div class="cumulative-pnl live">
            <span class="label">Cumulative Live PnL:</span>
            <span class="value" [class.profit]="state.long.cumLivePnl > 0" [class.loss]="state.long.cumLivePnl < 0">
              ${{ state.long.cumLivePnl | number:'1.2-2' }}
            </span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- SHORT SECTION -->
      <mat-card class="card short-card">
        <mat-card-header class="card-header">
          <mat-card-title>
            ðŸ“‰ SHORT Position
            @if (state.short.liveState.isLiveActive) {
              <mat-chip color="primary" selected>LIVE ACTIVE</mat-chip>
            } @else if (state.short.liveState.blockedAtMs) {
              <mat-chip color="warn">ðŸ”’ BLOCKED</mat-chip>
            } @else {
              <mat-chip>IDLE</mat-chip>
            }
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <!-- FSM State -->
          <div class="fsm-info">
            <span class="fsm-label">FSM:</span>
            <span class="fsm-state">{{ state.short.fsmState }}</span>
            <span class="fsm-label">Threshold:</span>
            <span class="fsm-value">{{ state.short.threshold ?? '--' }}</span>
          </div>

          <!-- Current Paper Trade -->
          <h4>Current Paper Trade</h4>
          @if (state.short.paperTrade) {
            <div class="trade-info">
              <div class="info-row">
                <span class="label">Entered At:</span>
                <span class="value entry-time">{{ state.short.paperTrade.timeIst }}</span>
              </div>
              <div class="info-row">
                <span class="label">Entry:</span>
                <span class="value">{{ state.short.paperTrade.entryPrice | number:'1.2-2' }}</span>
              </div>
              <div class="info-row">
                <span class="label">Current:</span>
                <span class="value">{{ state.short.paperTrade.currentPrice | number:'1.2-2' }}</span>
              </div>
              <div class="info-row pnl-row">
                <span class="label">Unrealized PnL:</span>
                <span class="value" [class.profit]="state.short.paperTrade.unrealizedPnl > 0" [class.loss]="state.short.paperTrade.unrealizedPnl < 0">
                  ${{ state.short.paperTrade.unrealizedPnl | number:'1.2-2' }}
                </span>
              </div>
            </div>
          } @else {
            <p class="empty">No SHORT position open</p>
          }

          <!-- Peak PnL History -->
          <h4>Peak PnL (Highest Unrealized)</h4>
          @if (state.short.currentPeakPnl !== null) {
            <div class="peak-current">
              <span class="time">{{ state.short.currentPeakPnl.timeIst }}</span>
              <span class="peak-value profit">${{ state.short.currentPeakPnl.pnl | number:'1.2-2' }}</span>
            </div>
          }
          @if ((state.short.peakPnlHistory ?? []).length > 0) {
            <div class="trades-list scrollable">
              @for (peak of state.short.peakPnlHistory ?? []; track peak.timestamp) {
                <div class="trade-row peak-row">
                  <span class="time">{{ peak.timeIst }}</span>
                  <span class="pnl profit">${{ peak.pnl | number:'1.2-2' }}</span>
                </div>
              }
            </div>
          } @else {
            <p class="empty">No peaks recorded</p>
          }

          <!-- Paper Trades History -->
          <h4>Paper Trades History <span class="trade-count">({{ state.short.paperTradeCount }} trades)</span></h4>
          @if ((state.short.paperTrades ?? []).length > 0) {
            <div class="trades-list scrollable">
              @for (trade of state.short.paperTrades ?? []; track trade.closedAt) {
                <div class="trade-row">
                  <span class="time">{{ trade.timeIst }} â†’ {{ trade.exitTimeIst }}</span>
                  <span class="price">{{ trade.entryPrice | number:'1.2-2' }} â†’ {{ trade.exitPrice | number:'1.2-2' }}</span>
                  <span class="pnl" [class.profit]="trade.realizedPnl > 0" [class.loss]="trade.realizedPnl < 0">
                    ${{ trade.realizedPnl | number:'1.2-2' }}
                  </span>
                </div>
              }
            </div>
          } @else {
            <p class="empty">No paper trades</p>
          }

          <!-- Live Trades -->
          <h4>Live Trades <span class="trade-count">({{ state.short.liveTradeCount }} trades)</span></h4>
          @if (state.short.liveState.trades.length > 0) {
            <div class="trades-list scrollable">
              @for (trade of state.short.liveState.trades; track trade.id) {
                <div class="trade-row" [class.entry]="trade.action === 'ENTRY'" [class.exit]="trade.action === 'EXIT'">
                  <span class="time">{{ trade.timeIst }}</span>
                  <span class="action">{{ trade.action }}</span>
                  <span class="price">@ {{ trade.entryPrice | number:'1.2-2' }}</span>
                  @if (trade.realizedPnl !== null) {
                    <span class="pnl" [class.profit]="trade.realizedPnl > 0" [class.loss]="trade.realizedPnl < 0">
                      ${{ trade.realizedPnl | number:'1.2-2' }}
                    </span>
                  }
                </div>
              }
            </div>
          } @else {
            <p class="empty">No live trades (activates when PnL > $0)</p>
          }

          <!-- Signal History -->
          <h4>Signal History</h4>
          @if ((state.short.signals ?? []).length > 0) {
            <div class="trades-list scrollable">
              @for (signal of state.short.signals ?? []; track signal.receivedAt) {
                <div class="trade-row signal-row">
                  <span class="time">{{ signal.timeIst }}</span>
                  <span class="action">{{ signal.intent }}</span>
                  <span class="price">stoppx: {{ signal.stoppx ?? '--' }}</span>
                  <span class="ltp">ltp: {{ signal.ltp ?? '--' }}</span>
                </div>
              }
            </div>
          } @else {
            <p class="empty">No signals</p>
          }

          <!-- Cumulative PnL -->
          <div class="cumulative-pnl paper">
            <span class="label">Cumulative Paper PnL:</span>
            <span class="value" [class.profit]="state.short.cumPaperPnl > 0" [class.loss]="state.short.cumPaperPnl < 0">
              ${{ state.short.cumPaperPnl | number:'1.2-2' }}
            </span>
          </div>
          <div class="cumulative-pnl live">
            <span class="label">Cumulative Live PnL:</span>
            <span class="value" [class.profit]="state.short.cumLivePnl > 0" [class.loss]="state.short.cumLivePnl < 0">
              ${{ state.short.cumLivePnl | number:'1.2-2' }}
            </span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  } @else {
    <p class="loading">Connecting to trading engine...</p>
  }
</section>
